---
#### Install packages using Homebrew
# brews list in vars/main
# casks list in vars/main
# extra casks for stuff I don't want on work machines
# add/remove as necessary
#
# linking the prereqs is a little dirty
####

- name: Fix perms on /usr/local
  file:
    path: "/usr/local/{{ item }}"
    owner: "{{ usernm }}"
    group: admin
    mode: 0775
    recurse: yes
    state: directory
  become: true
  become_user: root
  with_items:
    - bin
    - Caskroom
    - Homebrew
    - share
    - var

- name: Tap homebrew taps
  become: true
  become_user: "{{ usernm }}"
  homebrew_tap:
    name: "{{ item }}"
  with_items:
    "{{ taps }}"

- name: Update homebrew
  become: true
  become_user: "{{ usernm }}"
  homebrew:
    update_homebrew: yes

- name: Link prereqs
  become: true
  become_user: "{{ usernm }}"
  homebrew:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
  with_items:
    # needed for python
    - { name: gdbm, state: present }
    - { name: gdbm, state: linked }
    # needed for tmux
    - { name: libevent, state: present }
    - { name: libevent, state: linked }
    # needed for lots of stuff
    - { name: xz, state: present }
    - { name: xz, state: linked }

- name: Install default packages from homebrew
  become: true
  become_user: "{{ usernm }}"
  homebrew:
    name: "{{ item }}"
    state: present
  with_items:
    "{{ brews }}"

- name: Install extra packages from homebrew
  become: true
  become_user: "{{ usernm }}"
  homebrew:
    name: "{{ item }}"
    state: present
  when: extra_brews
  with_items:
    "{{ extra_brews }}"

- name: Install packages from homebrew cask
  become: true
  become_user: "{{ usernm }}"
  homebrew_cask:
    name: "{{ item }}"
    state: present
    install_options: 'appdir={{ home_dir }}/Applications'
  with_items:
    "{{ common_casks }}"

- name: Install extra casks from homebrew
  become: true
  become_user: "{{ usernm }}"
  homebrew:
    name: "{{ item }}"
    state: present
    install_options: 'appdir={{ home_dir }}/Applications'
  when: extra_casks
  with_items:
    "{{ extra_casks }}"

- name: Install fonts from homebrew cask
  become: true
  become_user: "{{ usernm }}"
  homebrew_cask:
    name: "{{ item }}"
    state: present
  with_items:
    "{{ font_casks }}"
  register: font_install

- name: Clear font caches on new font
  become: true
  become_user: root
  command: atsutil databases -remove
  when: font_install.changed
